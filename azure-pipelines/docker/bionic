ARG BASE
FROM $BASE
ARG CACHEBUST=1
RUN apt-get update
RUN apt-get -y install pkgconf clang git cmake curl libssl-dev libcurl4 libcurl4-openssl-dev libssh2-1-dev libz-dev valgrind openssh-client openssh-server
RUN if [ "$ARCH" != "armhf" -a "$ARCH" != "arm64" ]; then apt-get -y install openjdk-11-jre-headless; fi
RUN mkdir /var/run/sshd

RUN cd /tmp && \
    curl -LO https://tls.mbed.org/download/mbedtls-2.16.2-apache.tgz && \
    tar -xf mbedtls-2.16.2-apache.tgz && \
    rm -f mbedtls-2.16.2-apache.tgz && \
    cd mbedtls-2.16.2 && \
    scripts/config.pl set MBEDTLS_MD4_C 1 && \
    CFLAGS=-fPIC cmake -DENABLE_PROGRAMS=OFF -DENABLE_TESTING=OFF -DUSE_SHARED_MBEDTLS_LIBRARY=OFF -DUSE_STATIC_MBEDTLS_LIBRARY=ON . && \
    cmake --build . && \
    make install && \
    cd .. && \
    rm -rf mbedtls-2.16.2
